# Production Configuration (Blue-Green Deployment)
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# Or:    make prod
#
# This file provides zero-downtime deployments using blue-green strategy.
# Traffic switching is handled by Caddy via ACTIVE_BACKEND/ACTIVE_FRONTEND env vars.
#
# Commands:
#   make prod         - Deploy with zero downtime
#   make prod-status  - Show deployment status
#   make rollback     - Rollback to previous version

services:
  # ============================================
  # Shared Infrastructure (Production Tuned)
  # ============================================
  postgres:
    container_name: react-golang-postgres-prod
    build:
      context: ./backup
      dockerfile: postgres.Dockerfile
    restart: always
    environment:
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      # pgBackRest environment (for archive_command)
      PGBACKREST_STANZA: main
      PGBACKREST_REPO1_S3_BUCKET: ${BACKUP_S3_BUCKET:-}
      PGBACKREST_REPO1_S3_REGION: ${AWS_REGION:-us-east-1}
      PGBACKREST_REPO1_S3_KEY: ${AWS_ACCESS_KEY_ID:-}
      PGBACKREST_REPO1_S3_KEY_SECRET: ${AWS_SECRET_ACCESS_KEY:-}
      PGBACKREST_REPO1_CIPHER_PASS: ${BACKUP_ENCRYPTION_KEY:-}
    expose:
      - "5432"
    volumes:
      # Shared pgBackRest config (generated by backup container)
      - pgbackrest_config:/etc/pgbackrest:ro
      - pgbackrest_data:/var/lib/pgbackrest
      - pgbackrest_log:/var/log/pgbackrest
      - pgbackrest_spool:/var/spool/pgbackrest
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=1MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c log_min_duration_statement=1000
      -c archive_mode=on
      -c archive_command='pgbackrest --stanza=main archive-push %p'
      -c archive_timeout=60
      -c wal_level=replica
      -c max_wal_senders=3
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "1.0"
          memory: 512M

  dragonfly:
    container_name: react-golang-dragonfly-prod
    restart: always
    expose:
      - "6379"
    command: dragonfly --requirepass "${REDIS_PASSWORD:-}"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 128M

  # ============================================
  # Database Backup Service (pgBackRest)
  # ============================================
  backup:
    container_name: react-golang-backup
    build:
      context: ./backup
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # PostgreSQL connection
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: ${DB_USER:-devuser}
      PGPASSWORD: ${DB_PASSWORD:-devpass}
      PGDATABASE: ${DB_NAME:-starter_kit_db}
      # AWS S3 configuration
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      BACKUP_S3_BUCKET: ${BACKUP_S3_BUCKET:-}
      # Encryption
      BACKUP_ENCRYPTION_KEY: ${BACKUP_ENCRYPTION_KEY:-}
      # Retention settings
      BACKUP_RETENTION_FULL: ${BACKUP_RETENTION_FULL:-4}
      BACKUP_RETENTION_DIFF: ${BACKUP_RETENTION_DIFF:-30}
      # Performance
      BACKUP_PROCESS_MAX: ${BACKUP_PROCESS_MAX:-2}
      # Notifications (optional)
      BACKUP_SLACK_WEBHOOK: ${BACKUP_SLACK_WEBHOOK:-}
    volumes:
      # Shared pgBackRest config (write access to generate config)
      - pgbackrest_config:/shared-config
      - pgbackrest_data:/var/lib/pgbackrest
      - pgbackrest_log:/var/log/pgbackrest
      - pgbackrest_spool:/var/spool/pgbackrest
      # Access to postgres data for backups (read-only)
      - postgres_data:/var/lib/postgresql/data:ro
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/scripts/healthcheck.sh"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 2m
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    networks:
      - app-network

  # ============================================
  # Blue Environment
  # ============================================
  backend-blue:
    container_name: react-golang-backend-blue
    build:
      context: ./backend
      dockerfile: ./Dockerfile
      target: production
      args:
        BUILDKIT_INLINE_CACHE: 1
    restart: unless-stopped
    environment:
      # Database
      DB_HOST: postgres
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-devuser}
      DB_PASSWORD: ${DB_PASSWORD:-devpass}
      DB_NAME: ${DB_NAME:-starter_kit_db}
      DB_SSLMODE: ${DB_SSLMODE:-disable}
      # Auth
      JWT_SECRET: ${JWT_SECRET}
      ACCESS_TOKEN_EXPIRATION_MINUTES: ${ACCESS_TOKEN_EXPIRATION_MINUTES:-15}
      REFRESH_TOKEN_EXPIRATION_DAYS: ${REFRESH_TOKEN_EXPIRATION_DAYS:-7}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:5193,http://localhost:4193}
      API_PORT: 8080
      # Production settings
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DEBUG: false
      GO_ENV: production
      # Rate limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_GENERAL_REQUESTS: ${RATE_LIMIT_GENERAL_REQUESTS:-100}
      RATE_LIMIT_GENERAL_WINDOW: ${RATE_LIMIT_GENERAL_WINDOW:-1m}
      RATE_LIMIT_AUTH_REQUESTS: ${RATE_LIMIT_AUTH_REQUESTS:-5}
      RATE_LIMIT_AUTH_WINDOW: ${RATE_LIMIT_AUTH_WINDOW:-1m}
      # Migrations
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}
      MIGRATIONS_PATH: ${MIGRATIONS_PATH:-./migrations}
      # Background jobs
      JOBS_ENABLED: ${JOBS_ENABLED:-true}
      JOBS_WORKER_COUNT: ${JOBS_WORKER_COUNT:-10}
      # Email
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@localhost}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-App}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5193}
      # Stripe
      STRIPE_ENABLED: ${STRIPE_ENABLED:-false}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_SUCCESS_URL: ${STRIPE_SUCCESS_URL:-http://localhost:5193/billing/success}
      STRIPE_CANCEL_URL: ${STRIPE_CANCEL_URL:-http://localhost:5193/billing/cancel}
      STRIPE_PORTAL_RETURN_URL: ${STRIPE_PORTAL_RETURN_URL:-http://localhost:5193/billing}
      # Cache
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      CACHE_TYPE: redis
      REDIS_URL: redis://dragonfly:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    networks:
      - app-network

  frontend-blue:
    container_name: react-golang-frontend-blue
    build:
      context: ./frontend
      dockerfile: ./Dockerfile
      target: production
      args:
        VITE_API_URL: ${VITE_API_URL}
        BUILDKIT_INLINE_CACHE: 1
    restart: unless-stopped
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    networks:
      - app-network

  # ============================================
  # Green Environment
  # ============================================
  backend-green:
    container_name: react-golang-backend-green
    build:
      context: ./backend
      dockerfile: ./Dockerfile
      target: production
      args:
        BUILDKIT_INLINE_CACHE: 1
    restart: unless-stopped
    environment:
      # Database
      DB_HOST: postgres
      DB_PORT: ${DB_PORT:-5432}
      DB_USER: ${DB_USER:-devuser}
      DB_PASSWORD: ${DB_PASSWORD:-devpass}
      DB_NAME: ${DB_NAME:-starter_kit_db}
      DB_SSLMODE: ${DB_SSLMODE:-disable}
      # Auth
      JWT_SECRET: ${JWT_SECRET}
      ACCESS_TOKEN_EXPIRATION_MINUTES: ${ACCESS_TOKEN_EXPIRATION_MINUTES:-15}
      REFRESH_TOKEN_EXPIRATION_DAYS: ${REFRESH_TOKEN_EXPIRATION_DAYS:-7}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:5193,http://localhost:4193}
      API_PORT: 8080
      # Production settings
      LOG_LEVEL: ${LOG_LEVEL:-info}
      DEBUG: false
      GO_ENV: production
      # Rate limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_GENERAL_REQUESTS: ${RATE_LIMIT_GENERAL_REQUESTS:-100}
      RATE_LIMIT_GENERAL_WINDOW: ${RATE_LIMIT_GENERAL_WINDOW:-1m}
      RATE_LIMIT_AUTH_REQUESTS: ${RATE_LIMIT_AUTH_REQUESTS:-5}
      RATE_LIMIT_AUTH_WINDOW: ${RATE_LIMIT_AUTH_WINDOW:-1m}
      # Migrations
      RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}
      MIGRATIONS_PATH: ${MIGRATIONS_PATH:-./migrations}
      # Background jobs
      JOBS_ENABLED: ${JOBS_ENABLED:-true}
      JOBS_WORKER_COUNT: ${JOBS_WORKER_COUNT:-10}
      # Email
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@localhost}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-App}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5193}
      # Stripe
      STRIPE_ENABLED: ${STRIPE_ENABLED:-false}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_SUCCESS_URL: ${STRIPE_SUCCESS_URL:-http://localhost:5193/billing/success}
      STRIPE_CANCEL_URL: ${STRIPE_CANCEL_URL:-http://localhost:5193/billing/cancel}
      STRIPE_PORTAL_RETURN_URL: ${STRIPE_PORTAL_RETURN_URL:-http://localhost:5193/billing}
      # Cache
      CACHE_ENABLED: ${CACHE_ENABLED:-true}
      CACHE_TYPE: redis
      REDIS_URL: redis://dragonfly:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      dragonfly:
        condition: service_healthy
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    networks:
      - app-network

  frontend-green:
    container_name: react-golang-frontend-green
    build:
      context: ./frontend
      dockerfile: ./Dockerfile
      target: production
      args:
        VITE_API_URL: ${VITE_API_URL}
        BUILDKIT_INLINE_CACHE: 1
    restart: unless-stopped
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    networks:
      - app-network

  # ============================================
  # Caddy Reverse Proxy (Blue-Green Aware)
  # ============================================
  caddy:
    container_name: react-golang-caddy-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    environment:
      DOMAIN: ${DOMAIN:-localhost}
      ACTIVE_BACKEND: ${ACTIVE_BACKEND:-backend-blue}
      ACTIVE_FRONTEND: ${ACTIVE_FRONTEND:-frontend-blue}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          cpus: "0.1"
          memory: 32M
    # NOTE: No depends_on for backend/frontend - deployment script handles startup order
    # This allows Caddy to start independently and route to whichever env is active

networks:
  app-network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-react-golang-prod
