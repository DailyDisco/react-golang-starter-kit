# Production Configuration (Blue-Green Deployment)
# Usage: docker compose -f docker/compose.yml -f docker/compose.prod.yml up -d
# Or:    make prod
#
# Architecture:
# - Backend: Blue-green deployment with port switching
# - Frontend: Deploy separately to Vercel, Cloudflare Pages, or CDN
# - Database: PostgreSQL with production tuning
#
# Backup Strategy:
#   For production backups, we recommend using your cloud provider's native solutions:
#   - AWS RDS: Automated backups with point-in-time recovery
#   - Railway/Render: Automatic daily backups included
#   - Self-hosted: Use pg_dump + S3 sync via cron, or managed backup services
#
# Frontend Deployment Options:
#   - Vercel: vercel --prod (recommended)
#   - Cloudflare Pages: wrangler pages deploy dist
#   - S3 + CloudFront: aws s3 sync dist s3://bucket
#   - Any static host: Upload contents of frontend/dist
#
# Commands:
#   make prod         - Deploy with zero downtime
#   make prod-status  - Show deployment status
#   make rollback     - Rollback to previous version

# ============================================
# Shared Backend Configuration (YAML Anchor)
# ============================================
x-backend-common: &backend-common
  build:
    context: ../backend
    dockerfile: ./Dockerfile
    target: production
    args:
      BUILDKIT_INLINE_CACHE: 1
  restart: unless-stopped
  environment: &backend-env
    # Database - NO DEFAULTS! Prod must explicitly set credentials
    DB_HOST: postgres
    DB_PORT: ${DB_PORT:-5432}
    DB_USER: ${DB_USER:?DB_USER is required for production}
    DB_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required for production}
    DB_NAME: ${DB_NAME:?DB_NAME is required for production}
    DB_SSLMODE: ${DB_SSLMODE:-require}
    # Auth
    JWT_SECRET: ${JWT_SECRET}
    ACCESS_TOKEN_EXPIRATION_MINUTES: ${ACCESS_TOKEN_EXPIRATION_MINUTES:-15}
    REFRESH_TOKEN_EXPIRATION_DAYS: ${REFRESH_TOKEN_EXPIRATION_DAYS:-7}
    CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:5193,http://localhost:4193}
    API_PORT: 8080
    # Production settings
    LOG_LEVEL: ${LOG_LEVEL:-info}
    DEBUG: false
    GO_ENV: production
    # Rate limiting
    RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
    RATE_LIMIT_GENERAL_REQUESTS: ${RATE_LIMIT_GENERAL_REQUESTS:-100}
    RATE_LIMIT_GENERAL_WINDOW: ${RATE_LIMIT_GENERAL_WINDOW:-1m}
    RATE_LIMIT_AUTH_REQUESTS: ${RATE_LIMIT_AUTH_REQUESTS:-5}
    RATE_LIMIT_AUTH_WINDOW: ${RATE_LIMIT_AUTH_WINDOW:-1m}
    # Migrations
    RUN_MIGRATIONS: ${RUN_MIGRATIONS:-true}
    MIGRATIONS_PATH: ${MIGRATIONS_PATH:-./migrations}
    # Background jobs
    JOBS_ENABLED: ${JOBS_ENABLED:-true}
    JOBS_WORKER_COUNT: ${JOBS_WORKER_COUNT:-10}
    # Email
    EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
    SMTP_HOST: ${SMTP_HOST:-}
    SMTP_PORT: ${SMTP_PORT:-587}
    SMTP_USER: ${SMTP_USER:-}
    SMTP_PASSWORD: ${SMTP_PASSWORD:-}
    SMTP_FROM: ${SMTP_FROM:-noreply@localhost}
    SMTP_FROM_NAME: ${SMTP_FROM_NAME:-App}
    FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5193}
    # Stripe
    STRIPE_ENABLED: ${STRIPE_ENABLED:-false}
    STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
    STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
    STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
    STRIPE_SUCCESS_URL: ${STRIPE_SUCCESS_URL:-http://localhost:5193/billing/success}
    STRIPE_CANCEL_URL: ${STRIPE_CANCEL_URL:-http://localhost:5193/billing/cancel}
    STRIPE_PORTAL_RETURN_URL: ${STRIPE_PORTAL_RETURN_URL:-http://localhost:5193/billing}
    # Cache
    CACHE_ENABLED: ${CACHE_ENABLED:-true}
    CACHE_TYPE: redis
    REDIS_URL: redis://dragonfly:6379/0
  depends_on:
    postgres:
      condition: service_healthy
    dragonfly:
      condition: service_healthy
  healthcheck: &backend-healthcheck
    test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/ready"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 30s
  deploy: &backend-deploy
    resources:
      limits:
        cpus: "2.0"
        memory: 512M
      reservations:
        cpus: "0.5"
        memory: 128M
    restart_policy:
      condition: on-failure
      delay: 5s
      max_attempts: 3
      window: 120s
  networks:
    - app-network

services:
  # ============================================
  # Shared Infrastructure (Production Tuned)
  # ============================================
  postgres:
    container_name: ${PROJECT_NAME:-starter-kit}-postgres-prod
    image: postgres:17-alpine
    restart: always
    environment:
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    expose:
      - "5432"
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - postgres_logs_prod:/var/log/postgresql
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=1MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c log_min_duration_statement=1000
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "1.0"
          memory: 512M

  dragonfly:
    container_name: ${PROJECT_NAME:-starter-kit}-dragonfly-prod
    restart: always
    expose:
      - "6379"
    command: dragonfly --requirepass "${REDIS_PASSWORD:-}" --proactor_threads 1
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # ============================================
  # Blue Environment (Active)
  # ============================================
  backend-blue:
    <<: *backend-common
    container_name: ${PROJECT_NAME:-starter-kit}-backend-blue
    ports:
      - "${BACKEND_PORT:-8080}:8080"

  # ============================================
  # Green Environment (Standby)
  # ============================================
  backend-green:
    <<: *backend-common
    container_name: ${PROJECT_NAME:-starter-kit}-backend-green
    expose:
      - "8080"

volumes:
  postgres_data_prod:
  postgres_logs_prod:

networks:
  app-network:
    name: ${PROJECT_NAME:-starter-kit}-prod-network
    driver: bridge
