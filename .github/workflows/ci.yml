name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  GO_VERSION: "1.25"
  FRONTEND_DIR: frontend
  BACKEND_DIR: backend

jobs:
  # ============================================
  # Change Detection
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'package.json'
              - 'package-lock.json'
            backend:
              - 'backend/**'

  # ============================================
  # Frontend Jobs
  # ============================================
  frontend-checks:
    name: Frontend Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.FRONTEND_DIR }}

      # Run all checks in parallel using background processes
      - name: Run quality checks (parallel)
        run: |
          npm run prettier:check &
          PID_PRETTIER=$!
          npm run lint &
          PID_LINT=$!
          npm run typecheck &
          PID_TYPECHECK=$!
          npm audit --audit-level=high &
          PID_AUDIT=$!

          # Wait for all and capture exit codes
          FAIL=0
          wait $PID_PRETTIER || { echo "❌ Prettier check failed"; FAIL=1; }
          wait $PID_LINT || { echo "❌ Lint failed"; FAIL=1; }
          wait $PID_TYPECHECK || { echo "❌ Typecheck failed"; FAIL=1; }
          wait $PID_AUDIT || { echo "⚠️ Security audit found issues"; FAIL=1; }

          exit $FAIL
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Run tests with coverage
        run: npm run test:coverage
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Build frontend
        run: npm run build
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Check bundle size
        run: npm run size
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.FRONTEND_DIR }}/dist/
          retention-days: 7

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: ${{ env.FRONTEND_DIR }}/coverage/
          retention-days: 7

  frontend-e2e:
    name: Frontend E2E
    runs-on: ubuntu-latest
    needs: [changes, frontend-checks]
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.FRONTEND_DIR }}/dist/

      - name: Run Playwright tests
        run: npm run test:e2e
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ${{ env.FRONTEND_DIR }}/playwright-report/
          retention-days: 7

  # Matrix testing only on main branch pushes
  frontend-compat:
    name: Frontend Compat (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.changes.outputs.frontend == 'true'
    strategy:
      matrix:
        node-version: ["22"]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install and test
        run: npm ci && npm run test:coverage
        working-directory: ${{ env.FRONTEND_DIR }}

  # ============================================
  # Backend Jobs
  # ============================================
  backend-checks:
    name: Backend Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.BACKEND_DIR }}/go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          working-directory: ${{ env.BACKEND_DIR }}
          args: --timeout=5m
          install-mode: go-install

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@v1.16.6

      - name: Validate Swagger docs
        run: |
          mkdir -p /tmp/swagger-validate
          swag init -g cmd/main.go -o /tmp/swagger-validate
          sed -i '/LeftDelim:/d; /RightDelim:/d' /tmp/swagger-validate/docs.go
          if ! diff -q docs/swagger.json /tmp/swagger-validate/swagger.json; then
            echo "::error::Swagger docs outdated! Run: cd backend && make swagger"
            diff docs/swagger.json /tmp/swagger-validate/swagger.json || true
            exit 1
          fi
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Run tests with coverage
        run: |
          if find . -name "*_test.go" -type f | grep -q .; then
            go test -v -race -timeout 5m -coverprofile=coverage.out -covermode=atomic ./...
            go tool cover -func=coverage.out
          else
            echo "No Go test files found"
          fi
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Build backend
        run: go build -ldflags="-s -w" -o backend-linux-amd64 ./cmd/main.go
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: ${{ env.BACKEND_DIR }}/backend-linux-amd64
          retention-days: 7

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: hashFiles('backend/coverage.out') != ''
        with:
          name: backend-coverage
          path: ${{ env.BACKEND_DIR }}/coverage.out
          retention-days: 7

  backend-migrations:
    name: Backend Migrations
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.BACKEND_DIR }}/go.sum

      - name: Install golang-migrate
        run: go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Test migrations (up, down, up)
        run: |
          DB_URL="postgres://testuser:testpass@localhost:5432/testdb?sslmode=disable"
          migrate -path ./migrations -database "$DB_URL" up
          migrate -path ./migrations -database "$DB_URL" down -all
          migrate -path ./migrations -database "$DB_URL" up
          migrate -path ./migrations -database "$DB_URL" version
        working-directory: ${{ env.BACKEND_DIR }}

  # Integration Tests with real database
  backend-integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: [changes, backend-checks]
    if: needs.changes.outputs.backend == 'true'
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: starter_kit_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6382:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.BACKEND_DIR }}/go.sum

      - name: Install golang-migrate
        run: go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Run migrations
        run: |
          DB_URL="postgres://testuser:testpass@localhost:5433/starter_kit_test?sslmode=disable"
          migrate -path ./migrations -database "$DB_URL" up
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Run integration tests
        run: |
          go test -v -race -timeout 10m -coverprofile=coverage-integration.out -covermode=atomic ./...
        working-directory: ${{ env.BACKEND_DIR }}
        env:
          INTEGRATION_TEST: "true"
          TEST_DB_HOST: localhost
          TEST_DB_PORT: "5433"
          TEST_DB_USER: testuser
          TEST_DB_PASSWORD: testpass
          TEST_DB_NAME: starter_kit_test
          REDIS_URL: "redis://localhost:6382"

      - name: Upload integration coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-coverage
          path: ${{ env.BACKEND_DIR }}/coverage-integration.out
          retention-days: 7

  # Matrix testing only on main branch pushes
  backend-compat:
    name: Backend Compat (Go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.changes.outputs.backend == 'true'
    strategy:
      matrix:
        go-version: ["1.24"]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: ${{ env.BACKEND_DIR }}/go.sum

      - name: Run tests
        run: |
          if find . -name "*_test.go" -type f | grep -q .; then
            go test -v -race -timeout 5m ./...
          fi
        working-directory: ${{ env.BACKEND_DIR }}

  # ============================================
  # Container Security Scanning
  # ============================================
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: [changes, backend-checks]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image for scanning
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.BACKEND_DIR }}
          push: false
          load: true
          tags: backend:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (backend)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "backend:scan"
          format: "sarif"
          output: "trivy-backend-results.sarif"
          severity: "CRITICAL,HIGH"
          exit-code: "0"  # Don't fail build, just report

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-backend-results.sarif"
          category: "container-backend"

      - name: Run Trivy (table output for logs)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "backend:scan"
          format: "table"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "1"  # Fail on CRITICAL/HIGH
          ignore-unfixed: true

      - name: Scan Dockerfile for misconfigurations
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          scan-ref: "${{ env.BACKEND_DIR }}"
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"

  # ============================================
  # Summary
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [changes, frontend-checks, frontend-e2e, backend-checks, backend-migrations, backend-integration, container-security]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY

          # Frontend
          if [[ "${{ needs.changes.outputs.frontend }}" == "true" ]]; then
            echo "### Frontend" >> $GITHUB_STEP_SUMMARY
            echo "- Checks: ${{ needs.frontend-checks.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- E2E: ${{ needs.frontend-e2e.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Frontend: skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          # Backend
          if [[ "${{ needs.changes.outputs.backend }}" == "true" ]]; then
            echo "### Backend" >> $GITHUB_STEP_SUMMARY
            echo "- Checks: ${{ needs.backend-checks.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Migrations: ${{ needs.backend-migrations.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Integration: ${{ needs.backend-integration.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Backend: skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          # Container Security (only on main branch push)
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "### Container Security" >> $GITHUB_STEP_SUMMARY
            echo "- Scan: ${{ needs.container-security.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          # Determine overall status
          FRONTEND_OK=true
          BACKEND_OK=true

          if [[ "${{ needs.changes.outputs.frontend }}" == "true" ]]; then
            if [[ "${{ needs.frontend-checks.result }}" != "success" || "${{ needs.frontend-e2e.result }}" != "success" ]]; then
              FRONTEND_OK=false
            fi
          fi

          if [[ "${{ needs.changes.outputs.backend }}" == "true" ]]; then
            if [[ "${{ needs.backend-checks.result }}" != "success" || "${{ needs.backend-migrations.result }}" != "success" || "${{ needs.backend-integration.result }}" != "success" ]]; then
              BACKEND_OK=false
            fi
          fi

          if [[ "$FRONTEND_OK" == "true" && "$BACKEND_OK" == "true" ]]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All checks passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ============================================================================
  # Production Deployment (Blue-Green)
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ci-success, container-security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    concurrency:
      group: production-deploy
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.CONTAINER_REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Generate version tag
        id: version
        run: |
          VERSION=$(date +%Y%m%d)-${GITHUB_SHA::8}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: |
            ${{ vars.CONTAINER_REGISTRY }}/backend:${{ steps.version.outputs.version }}
            ${{ vars.CONTAINER_REGISTRY }}/backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ vars.CONTAINER_REGISTRY }}/frontend:${{ steps.version.outputs.version }}
            ${{ vars.CONTAINER_REGISTRY }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_API_URL=${{ vars.PRODUCTION_API_URL }}

      - name: Deploy to Blue environment
        id: deploy-blue
        run: |
          echo "Deploying version ${{ steps.version.outputs.version }} to blue environment..."
          # Deploy to blue environment (inactive)
          # This would typically use kubectl, docker-compose, or your deployment tool
          # Example: kubectl set image deployment/backend-blue backend=${{ vars.CONTAINER_REGISTRY }}/backend:${{ steps.version.outputs.version }}
          echo "Blue deployment complete"

      - name: Run smoke tests on Blue
        id: smoke-tests
        run: |
          echo "Running smoke tests against blue environment..."
          # Run health checks and basic functionality tests
          # Example: curl -f ${{ vars.BLUE_HEALTH_URL }}/health || exit 1
          echo "Smoke tests passed"

      - name: Switch traffic to Blue (promote)
        if: success()
        run: |
          echo "Promoting blue to production..."
          # Switch load balancer/ingress to point to blue
          # Example: kubectl patch ingress main -p '{"spec":{"rules":[{"host":"app.example.com","http":{"paths":[{"backend":{"service":{"name":"backend-blue"}}}]}}]}}'
          echo "Traffic switched to new deployment"

      - name: Rollback on failure
        if: failure() && steps.deploy-blue.outcome == 'success'
        run: |
          echo "Deployment failed, initiating rollback..."
          # Rollback to previous version (green environment)
          # Example: kubectl rollout undo deployment/backend-blue
          echo "Rollback complete"

      - name: Create deployment record
        if: success()
        run: |
          echo "### Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Deployment successful**" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "### ❌ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the logs above for details." >> $GITHUB_STEP_SUMMARY
