name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  GO_VERSION: "1.25"
  FRONTEND_DIR: ./frontend
  BACKEND_DIR: ./backend

jobs:
  # ============================================
  # Change Detection
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'package.json'
              - 'package-lock.json'
            backend:
              - 'backend/**'

  # ============================================
  # Frontend Jobs
  # ============================================
  frontend-checks:
    name: Frontend Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.FRONTEND_DIR }}

      # Run all checks in parallel using background processes
      - name: Run quality checks (parallel)
        run: |
          npm run prettier:check &
          PID_PRETTIER=$!
          npm run lint &
          PID_LINT=$!
          npm run typecheck &
          PID_TYPECHECK=$!
          npm audit --audit-level=high &
          PID_AUDIT=$!

          # Wait for all and capture exit codes
          FAIL=0
          wait $PID_PRETTIER || { echo "❌ Prettier check failed"; FAIL=1; }
          wait $PID_LINT || { echo "❌ Lint failed"; FAIL=1; }
          wait $PID_TYPECHECK || { echo "❌ Typecheck failed"; FAIL=1; }
          wait $PID_AUDIT || { echo "⚠️ Security audit found issues"; FAIL=1; }

          exit $FAIL
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Run tests with coverage
        run: npm run test:coverage
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Build frontend
        run: npm run build
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.FRONTEND_DIR }}/dist/
          retention-days: 7

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: ${{ env.FRONTEND_DIR }}/coverage/
          retention-days: 7

  frontend-e2e:
    name: Frontend E2E
    runs-on: ubuntu-latest
    needs: [changes, frontend-checks]
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
        working-directory: ${{ env.FRONTEND_DIR }}

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ${{ env.FRONTEND_DIR }}/dist/

      - name: Run Playwright tests
        run: npm run test:e2e
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ${{ env.FRONTEND_DIR }}/playwright-report/
          retention-days: 7

  # Matrix testing only on main branch pushes
  frontend-compat:
    name: Frontend Compat (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.changes.outputs.frontend == 'true'
    strategy:
      matrix:
        node-version: ["22"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install and test
        run: npm ci && npm run test:coverage
        working-directory: ${{ env.FRONTEND_DIR }}

  # ============================================
  # Backend Jobs
  # ============================================
  backend-checks:
    name: Backend Checks
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.BACKEND_DIR }}/go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: ${{ env.BACKEND_DIR }}
          args: --timeout=5m
          install-mode: go-install

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@v1.16.6

      - name: Validate Swagger docs
        run: |
          mkdir -p /tmp/swagger-validate
          swag init -g cmd/main.go -o /tmp/swagger-validate
          sed -i '/LeftDelim:/d; /RightDelim:/d' /tmp/swagger-validate/docs.go
          if ! diff -q docs/swagger.json /tmp/swagger-validate/swagger.json; then
            echo "::error::Swagger docs outdated! Run: cd backend && make swagger"
            diff docs/swagger.json /tmp/swagger-validate/swagger.json || true
            exit 1
          fi
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Run tests with coverage
        run: |
          if find . -name "*_test.go" -type f | grep -q .; then
            go test -v -race -timeout 5m -coverprofile=coverage.out -covermode=atomic ./...
            go tool cover -func=coverage.out
          else
            echo "No Go test files found"
          fi
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Build backend
        run: go build -ldflags="-s -w" -o backend-linux-amd64 ./cmd/main.go
        working-directory: ${{ env.BACKEND_DIR }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: ${{ env.BACKEND_DIR }}/backend-linux-amd64
          retention-days: 7

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: hashFiles('backend/coverage.out') != ''
        with:
          name: backend-coverage
          path: ${{ env.BACKEND_DIR }}/coverage.out
          retention-days: 7

  backend-migrations:
    name: Backend Migrations
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: ${{ env.BACKEND_DIR }}/go.sum

      - name: Install golang-migrate
        run: go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Test migrations (up, down, up)
        run: |
          DB_URL="postgres://testuser:testpass@localhost:5432/testdb?sslmode=disable"
          migrate -path ./migrations -database "$DB_URL" up
          migrate -path ./migrations -database "$DB_URL" down -all
          migrate -path ./migrations -database "$DB_URL" up
          migrate -path ./migrations -database "$DB_URL" version
        working-directory: ${{ env.BACKEND_DIR }}

  # Matrix testing only on main branch pushes
  backend-compat:
    name: Backend Compat (Go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && needs.changes.outputs.backend == 'true'
    strategy:
      matrix:
        go-version: ["1.24"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: ${{ env.BACKEND_DIR }}/go.sum

      - name: Run tests
        run: |
          if find . -name "*_test.go" -type f | grep -q .; then
            go test -v -race -timeout 5m ./...
          fi
        working-directory: ${{ env.BACKEND_DIR }}

  # ============================================
  # Summary
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [changes, frontend-checks, frontend-e2e, backend-checks, backend-migrations]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY

          # Frontend
          if [[ "${{ needs.changes.outputs.frontend }}" == "true" ]]; then
            echo "### Frontend" >> $GITHUB_STEP_SUMMARY
            echo "- Checks: ${{ needs.frontend-checks.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- E2E: ${{ needs.frontend-e2e.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Frontend: skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          # Backend
          if [[ "${{ needs.changes.outputs.backend }}" == "true" ]]; then
            echo "### Backend" >> $GITHUB_STEP_SUMMARY
            echo "- Checks: ${{ needs.backend-checks.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Migrations: ${{ needs.backend-migrations.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Backend: skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi

          # Determine overall status
          FRONTEND_OK=true
          BACKEND_OK=true

          if [[ "${{ needs.changes.outputs.frontend }}" == "true" ]]; then
            if [[ "${{ needs.frontend-checks.result }}" != "success" || "${{ needs.frontend-e2e.result }}" != "success" ]]; then
              FRONTEND_OK=false
            fi
          fi

          if [[ "${{ needs.changes.outputs.backend }}" == "true" ]]; then
            if [[ "${{ needs.backend-checks.result }}" != "success" || "${{ needs.backend-migrations.result }}" != "success" ]]; then
              BACKEND_OK=false
            fi
          fi

          if [[ "$FRONTEND_OK" == "true" && "$BACKEND_OK" == "true" ]]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All checks passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
