# Caddyfile for production deployment (blue-green)
# Caddy automatically provisions and renews TLS certificates via Let's Encrypt
#
# USAGE:
# 1. Set DOMAIN environment variable (or defaults to localhost)
# 2. Ensure DNS is pointing to your server
# 3. Deploy with: make prod
#
# Traffic is routed to the active environment via ACTIVE_BACKEND/ACTIVE_FRONTEND env vars.
# The deploy script handles switching automatically during deployments.

{$DOMAIN:localhost} {
	# Enable compression
	encode gzip zstd

	# Security headers
	header {
		# HSTS - Force HTTPS for 1 year, include subdomains
		# Note: Only enable preload after confirming HTTPS works across all subdomains
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		# Permissions policy - restrict browser features
		Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
		# Remove server identification
		-Server
	}

	# API routes - proxy to active backend (blue-green)
	handle /api/* {
		reverse_proxy {$ACTIVE_BACKEND:backend-blue}:8080 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
			# Health check for upstream
			health_uri /health
			health_interval 10s
			health_timeout 5s
		}
	}

	# Health check endpoint - proxy to active backend
	handle /health {
		reverse_proxy {$ACTIVE_BACKEND:backend-blue}:8080
	}

	# All other routes - proxy to active frontend (blue-green)
	handle {
		reverse_proxy {$ACTIVE_FRONTEND:frontend-blue}:80 {
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Logging
	log {
		output stdout
		format json
		level INFO
	}
}
